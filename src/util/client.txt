const source = new EventSource(`/__server?path=${location.pathname}`);

const rand = () => "?" + Math.random().toString(36).substring(2);

source.onmessage = ({ data }) => {
    data = JSON.parse(data);
    if (data.type === "refresh") {
        location.reload();
    }
    if (data.type === "crazy" && data.html) {
        let start = data.html.indexOf("<html>");
        if (start === -1) start = 0;
        let end = data.html.indexOf("</html>");
        if (end === -1) end = data.html.length;
        document.documentElement.innerHTML = data.html.substring(start, end);
        Array.from(document.scripts).forEach((script) => {
            if (script.type === "module") {
                const newScript = document.createElement("script");
                newScript.type = "module";
                if (script.dataset.src) {
                    newScript.dataset.src = script.dataset.src;
                }
                newScript.src = new URL(script.src).pathname + rand();
                script.remove();
                document.body.append(newScript);
            }
        });
    }
};
